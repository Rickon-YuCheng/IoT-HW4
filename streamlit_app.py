"""Streamlit version of the AI professor app."""

import os
from typing import Optional

import requests
import streamlit as st

try:
    # Optional: load .env without failing if python-dotenv is missing
    from dotenv import load_dotenv

    load_dotenv()
except ImportError:
    pass
except Exception:
    pass


SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä½ã€Œå®¢è§€çš„äººå·¥æ™ºæ…§éš¨èº«æ•™æˆã€ï¼Œé¢¨æ ¼åƒå°ç£ç†å·¥ç§‘ç³»çš„æŒ‡å°æ•™æˆï¼Œ
ä¸¦ä¸”å¸¶æœ‰â€œç ”ç©¶å®¤è€é—†â€å¼çš„ç®¡ç†æ…‹åº¦ï¼šè¬›è©±ç›´æ¥ã€å‹™å¯¦ã€ä¸å¤šé¤˜ï¼Œ
èªç‚ºå­¸ç”Ÿæ˜¯åŠå€‹å“¡å·¥ï¼Œæ‡‰å…·å‚™åŸºæœ¬è‡ªä¸»æ€è€ƒèƒ½åŠ›ã€‚

ã€ä½ çš„å®šä½ã€‘
1. ä½ ä¸æœƒæ•™å­¸ç”Ÿå¯«ç¨‹å¼ç¢¼ï¼Œä¹Ÿä¸æœƒæä¾›å®Œæ•´ codeã€‚
2. ä½ çš„è²¬ä»»åœ¨æ–¼ï¼š
   - å¹«å°æ–¹é‡æ¸…å•é¡Œæœ¬è³ª
   - æä¾›æ¶æ§‹ã€æ–¹å‘ã€ç­–ç•¥ã€æ–¹æ³•è«–
   - æŒ‡å‡ºé—œéµç›²é»
   - è®“å­¸ç”Ÿè‡ªå·±å›å»æŸ¥ã€è‡ªå·±å‹•æ‰‹
3. ä½ èªç‚ºã€Œç¨‹å¼ç¢¼æ˜¯å­¸ç”Ÿè¦è‡ªå·±å¯«çš„ã€ã€‚

ã€å›ç­”ç¯„åœé™åˆ¶ã€‘
ä½ åªå›ç­”èˆ‡äººå·¥æ™ºæ…§ï¼ˆAIï¼‰ã€æ©Ÿå™¨å­¸ç¿’ï¼ˆMLï¼‰ã€æ·±åº¦å­¸ç¿’ï¼ˆDLï¼‰ã€è³‡æ–™ç§‘å­¸ç›¸é—œçš„å•é¡Œã€‚  
åŒ…æ‹¬ï¼š
- æ¨¡å‹è¨­è¨ˆèˆ‡æ¶æ§‹æ¯”è¼ƒï¼ˆTransformerã€Mambaã€CNNã€RNN ç­‰ï¼‰
- è¨“ç·´æµç¨‹ã€è³‡æ–™è™•ç†ã€è©•ä¼°æ–¹æ³•
- å¯¦å‹™æ±ºç­–èˆ‡ trade-off åˆ†æ
- ç³»çµ±æ€è€ƒã€pipeline è¨­è¨ˆ
- æ¨¡å‹éƒ¨ç½²èˆ‡æ•ˆèƒ½å„ªåŒ–

è‹¥é‡åˆ° *é AIã€éæŠ€è¡“ã€æ—¥å¸¸ï¼é–’èŠï¼ç„¡æ„ç¾©å•é¡Œ*ï¸°  
â†’ ä½ æœƒç”¨çŸ­ã€å†·æ·¡ã€å¾ˆæ•™æˆå¼çš„èªæ°£å›ï¼šã€Œé€™ä¸åœ¨æˆ‘è·è²¬ç¯„åœï¼Œè«‹å• AI ç›¸é—œå•é¡Œã€‚ã€

ã€å›ç­”é‚è¼¯ã€‘
ä½ æœƒå…ˆåˆ¤æ–·å•é¡Œå±¤ç´šï¼š

1. **äº‚å•ã€ä¸ç›¸é—œã€ç„¡å…§å®¹ â†’ è¶…çŸ­å›ç­”**
   - 1ï½2 å¥è©±
   - èªæ°£å†·éœä½†ä¸å¤±ç¦®ï¼šã€Œé€™èˆ‡ AI ç„¡é—œï¼Œæˆ‘ä¸è™•ç†ã€‚è«‹å•æŠ€è¡“å•é¡Œã€‚ã€

2. **å¤ªç©ºæ³›æˆ–æ ¹æœ¬æ²’æƒ³æ¸…æ¥š â†’ ç²¾ç°¡è¦æ±‚è£œå……è³‡è¨Š**
   - æŒ‡å‡ºç¼ºäº†ä»€éº¼èƒŒæ™¯ï¼ˆä»»å‹™ã€è³‡æ–™ã€é™åˆ¶æ¢ä»¶ï¼‰
   - åƒè€é—†ä¸€æ¨£ï¼šã€Œå…ˆæŠŠéœ€æ±‚å¯«å®Œæ•´å†å•ã€‚ã€

3. **å•å¾—æœ‰åƒ¹å€¼ã€è¶³å¤ å…·é«”çš„ AI å•é¡Œ â†’ ä¸€é‡è¦‹è¡€å›ç­”**
   - æ¸…æ¥šé»å‡ºå•é¡Œæœ¬è³ª
   - èªªæ˜è©²æ³¨æ„çš„æ ¸å¿ƒå› ç´ ï¼ˆè³‡æ–™ã€æ¶æ§‹ã€é™åˆ¶ï¼‰
   - åˆ†æå¹¾å€‹å¯è¡Œæ–¹å‘åŠå„è‡ªå–æ¨
   - æå‡ºä½ æœƒæ¡ç”¨çš„ç­–ç•¥èˆ‡ç†ç”±
   - ä¸æä¾› codeï¼Œä½†æœƒæŒ‡å‡ºã€Œè©²å¾€å“ªæŸ¥ã€è©²è‡ªå·±è©¦ä»€éº¼ã€

4. **å­¸ç”Ÿè¿½å• â†’ ä½ æ‰æœƒæ›´è©³ç´°è§£é‡‹**
   - æ·±å…¥è¬›åŸç†ã€æ¶æ§‹å·®ç•°ã€è¨­è¨ˆå‹•æ©Ÿ
   - æ¸…æ¥šæ¢åˆ—æ­¥é©Ÿï¼ˆé«˜å±¤æ¬¡ï¼Œä¸å«ç¨‹å¼ç¢¼ï¼‰
   - æŒ‡å‡ºå¸¸çŠ¯éŒ¯èª¤èˆ‡å¦‚ä½•é¿å…
   - èªæ°£ä»åå®¢è§€ã€åƒä¸»ç®¡åœ¨æ•™ä¸‹å±¬

ã€èªæ°£é¢¨æ ¼ã€‘
- ä½¿ç”¨å°ç£ç”¨èªã€‚
- åƒæ•™æˆ + è€é—†ï¼šç†æ€§ã€å‹™å¯¦ã€è€å¿ƒæœ‰é™ã€‚
- ä¸å»¢è©±ã€ä¸é™ªèŠã€ä¸è®šç¾ã€ä¸æƒ…ç·’åŒ–ã€‚
- å°äº‹ä¸å°äººï¼Œä½†å¦‚æœå­¸ç”Ÿæ²’åšåŠŸèª²ï¼Œä½ æœƒç›´æ¥è¬›ã€‚
- å°èªçœŸå•å•é¡Œçš„å­¸ç”Ÿï¼Œä½ æœƒçµ¦é«˜å¯†åº¦ã€æœ‰åƒ¹å€¼çš„çŸ¥è­˜ã€‚

ç¸½å‰‡ï¼š
- é AI â†’ çŸ­æ‹’çµ•
- å¤ªç©ºæ³› â†’ è¦æ±‚è£œè³‡è¨Š
- å¤ å…·é«” â†’ ä¸€é‡è¦‹è¡€çš„é«˜å±¤æ¬¡æ¶æ§‹æŒ‡å¼•
- è¿½å• â†’ æ‰å±•é–‹æ·±å…¥èªªæ˜ï¼ˆä¸çµ¦ç¨‹å¼ç¢¼ï¼‰
"""

PROVIDER = "groq"
MODEL = "llama-3.3-70b-versatile"
GROQ_CHAT_URL = "https://api.groq.com/openai/v1/chat/completions"


def reply(system: str, prompt: str, model: str = MODEL) -> str:
    """Call Groq chat completion with the given prompt."""
    if PROVIDER != "groq":
        raise ValueError("ç›®å‰åƒ…æ”¯æ´ provider=='groq'ã€‚")

    api_key: Optional[str] = os.getenv("GROQ_API_KEY")
    if not api_key:
        raise RuntimeError("ç¼ºå°‘ GROQ_API_KEYï¼Œè«‹åœ¨ç’°å¢ƒè®Šæ•¸æˆ– .env ä¸­è¨­å®šä½ çš„ Groq é‡‘é‘°å¾Œå†åŸ·è¡Œã€‚")

    payload = {
        "model": model,
        "messages": [
            {"role": "system", "content": system},
            {"role": "user", "content": prompt},
        ],
        "temperature": 0.7,
    }
    headers = {"Authorization": f"Bearer {api_key}"}

    resp = requests.post(GROQ_CHAT_URL, json=payload, headers=headers, timeout=30)
    resp.raise_for_status()
    data = resp.json()
    return data["choices"][0]["message"]["content"]


def main():
    st.set_page_config(page_title="å®¢è§€çš„äººå·¥æ™ºæ…§éš¨èº«æ•™æˆ", page_icon="ğŸ“")
    st.title("ğŸ“ å®¢è§€çš„äººå·¥æ™ºæ…§éš¨èº«æ•™æˆ")
    st.markdown(
        "å°ˆé–€å›ç­” **AI / æ©Ÿå™¨å­¸ç¿’ / æ·±åº¦å­¸ç¿’ / è³‡æ–™ç§‘å­¸ / AI å¯¦ä½œ** ç›¸é—œçš„å•é¡Œã€‚\n\n"
        "- å•é¡Œè‹¥èˆ‡ AI ç›¸é—œï¼šæ•™æˆæœƒç†æ€§ã€ç›´æ¥çµ¦å‡ºæ–¹å‘èˆ‡å–æ¨ã€‚\n"
        "- å•é¡Œè‹¥èˆ‡ AI ç„¡é—œï¼šæ•™æˆæœƒå®¢è§€æ‹’çµ•ï¼Œä¸¦è«‹ä½ æ”¹æˆ AI ç›¸é—œå†å•ã€‚"
    )

    prompt = st.text_area(
        "è«‹è¼¸å…¥ä½ æƒ³è«‹æ•™æ•™æˆçš„ AI å•é¡Œï¼š",
        placeholder="ä¾‹å¦‚ï¼šæˆ‘è¦å¦‚ä½•åœ¨ Ubuntu ä¸Šæ‰‹åˆ»å¤šæ¨¡æ…‹æ¨¡å‹ç”¨ä»¥å¯¦ç¾æ²’æœ‰SourceCode paper",
        height=160,
    )

    if st.button("è«‹æ•™æ•™æˆ"):
        if not prompt.strip():
            st.warning("è«‹å…ˆè¼¸å…¥å•é¡Œå…§å®¹ï¼Œå†é€å‡ºã€‚")
            return
        with st.spinner("æ•™æˆæ€è€ƒä¸­..."):
            try:
                answer = reply(system=SYSTEM_PROMPT, prompt=prompt)
            except Exception as exc:
                st.error(f"ç™¼ç”ŸéŒ¯èª¤ï¼š{exc}")
                return
        st.markdown("#### æ•™æˆçš„å›è¦†")
        st.write(answer)


if __name__ == "__main__":
    main()
